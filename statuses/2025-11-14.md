---
tags:
- Rust
- Crafting Interpreters é˜…è¯»ç¬”è®°
---

ä»Šæ—¥å¤§æˆ˜borrow checkerï¼š

```rust
enum E {
    A(usize),
    B,
}

struct S {
    x: i32,
    e: E,
}

fn f(s: &mut Vec<S>) {
    match &s[0].e {
        E::A(index) => s[*index].x = 114514,
        _ => {}
    }
}
```

```console
error[E0502]: cannot borrow `*s` as mutable because it is also borrowed as immutable
  --> src/main.rs:13:24
   |
12 |     match &s[0].e {
   |            - immutable borrow occurs here
13 |         E::A(index) => s[*index].x = 114514,
   |                        ^ ------ immutable borrow later used here
   |                        |
   |                        mutable borrow occurs here
   |
   = help: use `.split_at_mut(position)` to obtain two mutable non-overlapping sub-slices
```

æ­¤å¤„åŒæ—¶æŒæœ‰ä¸å¯å˜å¼•ç”¨å’Œå¯å˜å¼•ç”¨ç†è®ºä¸Šæ²¡æœ‰é—®é¢˜ï¼Œå› ä¸ºè¯»çš„æ˜¯eè€Œå†™çš„æ˜¯xã€‚

ç¼–è¯‘å™¨æç¤ºçš„split\_at\_mutå¹¶ä¸å®Œå…¨é€‚ç”¨ï¼Œå› ä¸ºindexå¯èƒ½æ˜¯0ã€‚

æœ€åæˆ‘å†™å‡ºäº†ä¸€æ®µè¶…çº§æŠ½è±¡çš„match matchï¼š

```rust
fn f(s: &mut Vec<S>) {
    match match &s[0].e {
        E::A(index) => Some(*index),
        _ => None,
    } {
        Some(index) => s[index].x = 114514,
        None => {}
    }
}
```

ä»¥ä¸Šæ˜¯åœ¨å®ç°[Crafting Interpreters Â§ 25.3](https://craftinginterpreters.com/closures.html#upvalues-in-closures)ä¹‹OP_SET_UPVALUEæŒ‡ä»¤æ—¶é‡åˆ°çš„é—®é¢˜ã€‚å‡½æ•°å’Œé—­åŒ…ä¸¤ç« ç»™æˆ‘å†™åˆ°æ€€ç–‘äººç”Ÿäº† ğŸ˜¾ æŒ‡é’ˆä¹±é£ï¼Œç”Ÿå‘½å‘¨æœŸä¸€æ¡¶æµ†ç³Šï¼Œæ€ªä¸å¾—ç”¨Rustå†™cloxçš„æœ€åéƒ½å‘æ‰äº† ğŸ˜¾
